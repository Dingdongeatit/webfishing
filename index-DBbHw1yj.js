(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const u of a.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&o(u)}).observe(document,{childList:!0,subtree:!0});function n(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(r){if(r.ep)return;r.ep=!0;const a=n(r);fetch(r.href,a)}})();const I={steamID:Math.floor(Math.random()*1e6),personaName:"Player"};function q(){const e=localStorage.getItem("settings");if(e)return JSON.parse(e);{const t=JSON.parse(JSON.stringify(I));return x(t),t}}const b=q();function x(e){localStorage.setItem("settings",JSON.stringify(e))}var s=(e=>(e[e.C2SHello=1]="C2SHello",e[e.C2SGetLobbies=2]="C2SGetLobbies",e[e.S2CLobbies=3]="S2CLobbies",e[e.C2SPacket=4]="C2SPacket",e[e.S2CPacket=5]="S2CPacket",e[e.C2SCreateLobby=6]="C2SCreateLobby",e[e.S2CCreateLobby=7]="S2CCreateLobby",e[e.C2SJoinLobby=8]="C2SJoinLobby",e[e.S2CJoinLobby=9]="S2CJoinLobby",e[e.C2SSetCode=10]="C2SSetCode",e[e.C2SLeaveLobby=11]="C2SLeaveLobby",e[e.S2CPlayerJoined=13]="S2CPlayerJoined",e[e.S2CPlayerLeft=14]="S2CPlayerLeft",e[e.S2CCurrentLobby=15]="S2CCurrentLobby",e))(s||{}),E=(e=>(e[e.Success=1]="Success",e[e.DoesntExist=2]="DoesntExist",e[e.Full=4]="Full",e[e.Error=5]="Error",e))(E||{}),m=(e=>(e[e.Joined=1]="Joined",e[e.Left=2]="Left",e))(m||{});const B=()=>window.self!==window.top,y=B()?"/.proxy/":"/",v="FILE_DATA",S="/userfs/webfishing_save_slot_0.sav",w=new URL(window.location.href);w.protocol=w.protocol==="https:"?"wss:":"ws:";w.pathname=y+"ws";const h=new WebSocket(w.toString()),i=new Map;let c=null;function d(e){h.send(JSON.stringify(e))}function j(e){d({type:s.C2SSetCode,code:e}),c!=null&&(c.code=e);const t=Array.from(i.values()).find(n=>n.id===(c==null?void 0:c.id));t!=null&&(t.code=e)}const O=new EventTarget;class A extends Event{constructor(t){super("message"),this.data=t}}h.addEventListener("open",()=>{d({type:s.C2SHello,steam:{id:b.steamID,name:b.personaName}})});h.addEventListener("message",e=>{const t=JSON.parse(e.data);switch(t.type){case s.S2CLobbies:{i.clear();for(const n of t.lobbies)i.set(n.id,n);break}case s.S2CCreateLobby:{i.set(t.lobby.id,t.lobby);break}case s.S2CJoinLobby:{t.response===E.Success&&(c=i.get(t.id)??null);break}case s.S2CCurrentLobby:{c=t.lobby,i.set(t.lobby.id,t.lobby);break}}O.dispatchEvent(new A(t))});const p=new Map,l=new Set;function U(e){var t,n;switch(e.type){case"poll":{const o=Array.from(l);return l.clear(),o}case"requestLobbyList":{d({type:s.C2SGetLobbies});break}case"getLobbyData":return console.log(i,e),i.get(e.id);case"getLobbyMemberByIndex":{const o=i.get(e.lobby);return console.log(o,e),o==null?null:o.players[e.index]}case"getFriendPersonaName":{const o=c;return o==null?null:(t=o.players.find(r=>r.id===e.id))==null?void 0:t.name}case"getNumLobbyMembers":{const o=i.get(e.lobby);return o==null?0:o.players.length}case"createLobby":{d({type:s.C2SCreateLobby,maxPlayers:e.maxPlayers});break}case"joinLobby":{d({type:s.C2SJoinLobby,id:e.id});break}case"leaveLobby":{d({type:s.C2SLeaveLobby});break}case"setCode":{j(e.code);break}case"getLobbyOwner":return(n=i.get(e.id))==null?void 0:n.ownerId;case"getAvailableP2PPacketSize":{const o=e.channel,r=p.get(o);return r==null||r.length===0?0:r[0].data.length}case"readP2PPacket":{const o=e.channel,r=p.get(o);return r==null||r.length===0?null:r.shift()}case"getSteamID":return b.steamID;case"getPersonaName":return b.personaName;case"sendP2PPacket":{d({type:s.C2SPacket,member:e.member,channel:e.channel,data:e.data});break}default:throw new Error("Unknown message type: "+JSON.stringify(e))}}window.bridge={process(e){const t=JSON.parse(e),n=U(t);return JSON.stringify(n??null)}};O.addEventListener("message",e=>{if(e instanceof A)switch(e.data.type){case s.S2CLobbies:{l.add({type:"lobby_match_list",data:e.data.lobbies.map(t=>t.id)});break}case s.S2CPacket:{const t=p.get(e.data.channel),n={sender:e.data.sender,data:e.data.data};t==null?p.set(e.data.channel,[n]):t.push(n);break}case s.S2CCreateLobby:{l.add({type:"lobby_created",id:e.data.lobby.id});break}case s.S2CJoinLobby:{l.add({type:"lobby_joined",id:e.data.id,response:e.data.response});break}case s.S2CPlayerJoined:{l.add({type:"p2p_session_request",id:e.data.player.id}),l.add({type:"lobby_chat_update",id:(c==null?void 0:c.id)??0,player:e.data.player.id,state:m.Joined});break}case s.S2CPlayerLeft:{l.add({type:"lobby_chat_update",id:(c==null?void 0:c.id)??0,player:e.data.player.id,state:m.Left});break}}});const k="webfishing_2_newver",F=k+".pck",f=new window.Engine({canvasResizePolicy:2,executable:y+k,focusCanvas:!0,args:["--main-pack",F]}),L=document.querySelector("#exe");L.addEventListener("input",()=>{const e=L.files[0],t=new FileReader;t.onload=async()=>{if(!(t.result instanceof ArrayBuffer))throw new Error("Expected ArrayBuffer");await f.preloadFile(t.result,F),await f.start(),document.querySelector("#app").style.display="none"},t.readAsArrayBuffer(e)});(async()=>{await f.init(y+k);const e=await fetch(y+"Steam.gdc").then(n=>n.arrayBuffer());await f.preloadFile(e,"Steam.gdc");const t=`
[autoload]
Steam="*./Steam.gdc"
`.trim();await f.preloadFile(new TextEncoder().encode(t),"override.cfg"),L.disabled=!1})();async function P(){if(!(await window.indexedDB.databases()).some(n=>n.name==="/userfs"))throw new Error("Database does not exist");const t=window.indexedDB.open("/userfs",21);return await new Promise((n,o)=>{t.onsuccess=()=>{n(t.result)},t.onerror=()=>{o(t.error)}})}async function g(e,t,n,o){const r=e.transaction(t,n),a=r.objectStore(t),u=await o(a);return await new Promise((_,D)=>{r.oncomplete=()=>{_(u)},r.onerror=()=>{D(r.error)}})}async function G(e,t){return await new Promise((n,o)=>{const r=e.get(t);r.onsuccess=()=>{n(r.result)},r.onerror=()=>{o(r.error)}})}async function H(e,t,n){return await new Promise((o,r)=>{const a=e.put(t,n);a.onsuccess=()=>{o()},a.onerror=()=>{r(a.error)}})}async function z(e,t){return await new Promise((n,o)=>{const r=e.delete(t);r.onsuccess=()=>{n()},r.onerror=()=>{o(r.error)}})}var N;(N=document.querySelector("#canvas"))==null||N.addEventListener("click",e=>{e.preventDefault()});const C=document.querySelector("#username");C.value=b.personaName;C.addEventListener("input",()=>{b.personaName=C.value,x(b)});const J=document.querySelector("#save");J.addEventListener("input",()=>{const e=J.files[0],t=new FileReader;t.onload=async()=>{if(!(t.result instanceof ArrayBuffer))throw new Error("Expected ArrayBuffer");const n=new Uint8Array(t.result),o=await P();try{await g(o,v,"readwrite",async r=>{await H(r,{timestamp:new Date().toISOString(),mode:33206,contents:n},S)})}catch(r){console.error("Failed to save file",r)}o.close()},t.readAsArrayBuffer(e)});const K=document.querySelector("#downloadSave");K.addEventListener("click",async()=>{const e=await P(),t=await g(e,v,"readonly",async a=>await G(a,S));if(e.close(),!t){console.error("No file found");return}const n=new Blob([t.contents],{type:"application/octet-stream"}),o=URL.createObjectURL(n),r=document.createElement("a");r.href=o,r.download=S.split("/").pop(),r.click()});const W=document.querySelector("#resetSave");W.addEventListener("click",async()=>{if(!confirm("reset the save file?"))return;const e=await P();await g(e,v,"readwrite",async t=>{await z(t,S)}),e.close()});
